name: OpenCode Agent (@sisyphus-dev-ai)

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Custom prompt'
        required: false
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]

jobs:
  agent:
    runs-on: ubuntu-latest
    # @sisyphus-dev-ai mention only (maintainers, exclude self)
    if: |
      github.event_name == 'workflow_dispatch' ||
      (contains(github.event.comment.body || github.event.review.body, '@sisyphus-dev-ai') && 
       (github.event.comment.user.login || github.event.review.user.login) != 'sisyphus-dev-ai' &&
       contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association || github.event.review.author_association))
    
    # Minimal default GITHUB_TOKEN permissions
    permissions:
      contents: read
    
    steps:
      # Checkout with sisyphus-dev-ai's PAT
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      # Git config - commits as sisyphus-dev-ai
      - name: Configure Git as sisyphus-dev-ai
        run: |
          git config user.name "sisyphus-dev-ai"
          git config user.email "sisyphus-dev-ai@users.noreply.github.com"

      # gh CLI auth as sisyphus-dev-ai
      - name: Authenticate gh CLI as sisyphus-dev-ai
        run: |
          echo "${{ secrets.GH_PAT }}" | gh auth login --with-token
          gh auth status

      # Install Bun with caching
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Cache OpenCode
        uses: actions/cache@v4
        with:
          path: |
            ~/.opencode
            ~/.config/opencode
          key: ${{ runner.os }}-opencode-${{ hashFiles('.github/workflows/sisyphus-agent.yml') }}
          restore-keys: |
            ${{ runner.os }}-opencode-

      # Install OpenCode + oh-my-opencode + auth in single step
      - name: Setup OpenCode with oh-my-opencode
        env:
          OPENCODE_AUTH_JSON: ${{ secrets.OPENCODE_AUTH_JSON }}
        run: |
          # Install OpenCode
          curl -fsSL https://opencode.ai/install | bash
          export PATH="$HOME/.opencode/bin:$PATH"
          opencode --version
          
          # Install oh-my-opencode using the proper installer
          bunx oh-my-opencode install --no-tui --claude=yes --chatgpt=yes --gemini=no
          
          # Setup auth
          mkdir -p ~/.local/share/opencode
          echo "$OPENCODE_AUTH_JSON" > ~/.local/share/opencode/auth.json
          chmod 600 ~/.local/share/opencode/auth.json
          
          # Verify setup
          cat ~/.config/opencode/opencode.json

      # Collect context
      - name: Collect Context
        id: context
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          EVENT="${{ github.event_name }}"
          
          if [[ "$EVENT" == "issue_comment" ]]; then
            ISSUE_NUM="${{ github.event.issue.number }}"
            COMMENT="${{ github.event.comment.body }}"
            AUTHOR="${{ github.event.comment.user.login }}"
            COMMENT_ID="${{ github.event.comment.id }}"
            
            # Check if PR or Issue
            if gh api "repos/${{ github.repository }}/issues/${ISSUE_NUM}" | jq -e '.pull_request' > /dev/null; then
              echo "type=pr" >> $GITHUB_OUTPUT
              echo "number=${ISSUE_NUM}" >> $GITHUB_OUTPUT
            else
              echo "type=issue" >> $GITHUB_OUTPUT
              echo "number=${ISSUE_NUM}" >> $GITHUB_OUTPUT
            fi
          elif [[ "$EVENT" == "pull_request_review_comment" ]]; then
            echo "type=pr" >> $GITHUB_OUTPUT
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            COMMENT="${{ github.event.comment.body }}"
            AUTHOR="${{ github.event.comment.user.login }}"
            COMMENT_ID="${{ github.event.comment.id }}"
          elif [[ "$EVENT" == "pull_request_review" ]]; then
            echo "type=pr" >> $GITHUB_OUTPUT
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            COMMENT="${{ github.event.review.body }}"
            AUTHOR="${{ github.event.review.user.login }}"
            COMMENT_ID=""
          fi
          
          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "comment_id=$COMMENT_ID" >> $GITHUB_OUTPUT

      # Add :eyes: reaction (as sisyphus-dev-ai)
      - name: Add eyes reaction
        if: steps.context.outputs.comment_id != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh api "/repos/${{ github.repository }}/issues/comments/${{ steps.context.outputs.comment_id }}/reactions" \
            -X POST -f content="eyes" || true

      # Run OpenCode
      - name: Run OpenCode
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          CONTEXT_TYPE: ${{ steps.context.outputs.type }}
          CONTEXT_NUMBER: ${{ steps.context.outputs.number }}
          CONTEXT_AUTHOR: ${{ steps.context.outputs.author }}
          CONTEXT_COMMENT: ${{ steps.context.outputs.comment }}
          REPO_NAME: ${{ github.repository }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          export PATH="$HOME/.opencode/bin:$PATH"
          
          cat > /tmp/agent-prompt.md << 'PROMPT_EOF'
          ulw

          You are sisyphus-dev-ai. You've been mentioned by @AUTHOR_PLACEHOLDER in REPO_PLACEHOLDER.
          Find out what's happening and satisfy the user's request.

          ## Context
          - Type: TYPE_PLACEHOLDER (issue or pr)
          - Number: #NUMBER_PLACEHOLDER
          - Repository: REPO_PLACEHOLDER

          ## User's Message
          COMMENT_PLACEHOLDER

          ---

          ## CRITICAL: GitHub Comments Are Your ONLY Output

          **The user CANNOT see your console output.** They can ONLY see GitHub comments.
          Every response, every update, every result MUST be posted as a GitHub comment.

          ## Workflow

          ### 1. Acknowledge IMMEDIATELY
          ```bash
          gh issue comment NUMBER_PLACEHOLDER --body "ðŸ‘‹ Hey @AUTHOR_PLACEHOLDER! I'm on it. Let me check this out..."
          ```

          ### 2. Setup Dev Environment
          ```bash
          bun install
          bun run typecheck
          ```

          ### 3. Investigate
          - Read context: `gh issue view NUMBER_PLACEHOLDER` or `gh pr view NUMBER_PLACEHOLDER`
          - If PR: `gh pr diff NUMBER_PLACEHOLDER`
          - Explore codebase as needed

          ### 4. If Code Changes Needed â†’ Create PR
          ```bash
          # Create branch
          BRANCH="sisyphus/issue-NUMBER_PLACEHOLDER-$(date +%s)"
          git checkout -b "$BRANCH"

          # Make changes...

          # Commit
          git add -A
          git commit -m "feat: description

          Requested by @AUTHOR_PLACEHOLDER in #NUMBER_PLACEHOLDER

          ðŸ¤– Generated with [OhMyOpenCode](https://github.com/code-yeongyu/oh-my-opencode)"

          # Push and create PR
          git push -u origin "$BRANCH"
          gh pr create --title "feat: title" --body "## Summary
          What was done

          Closes #NUMBER_PLACEHOLDER

          ---
          ðŸ¤– Generated with [OhMyOpenCode](https://github.com/code-yeongyu/oh-my-opencode)" --base DEFAULT_BRANCH_PLACEHOLDER
          ```

          ### 5. Report Back (ALWAYS)
          ```bash
          gh issue comment NUMBER_PLACEHOLDER --body "## Done! âœ…

          Here's what I did:
          - ...

          PR: <link if created>"
          ```

          ## Rules
          - EVERY response = GitHub comment (user sees nothing else)
          - Code changes = PR (never push to main/master directly)
          - Setup dev env first (bun install)
          - Be concise but helpful

          ## Git Config (Pre-configured)
          - user.name: sisyphus-dev-ai
          - user.email: sisyphus-dev-ai@users.noreply.github.com
          PROMPT_EOF

          # Replace placeholders with actual values
          sed -i "s/AUTHOR_PLACEHOLDER/${CONTEXT_AUTHOR}/g" /tmp/agent-prompt.md
          sed -i "s/TYPE_PLACEHOLDER/${CONTEXT_TYPE}/g" /tmp/agent-prompt.md
          sed -i "s/NUMBER_PLACEHOLDER/${CONTEXT_NUMBER}/g" /tmp/agent-prompt.md
          sed -i "s|REPO_PLACEHOLDER|${REPO_NAME}|g" /tmp/agent-prompt.md
          sed -i "s/DEFAULT_BRANCH_PLACEHOLDER/${DEFAULT_BRANCH}/g" /tmp/agent-prompt.md
          sed -i "s/COMMENT_PLACEHOLDER/${CONTEXT_COMMENT}/g" /tmp/agent-prompt.md
          
          opencode run "$(cat /tmp/agent-prompt.md)"

      # Push changes (as sisyphus-dev-ai)
      - name: Push changes
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git add -A
            git commit -m "chore: changes by sisyphus-dev-ai" || true
          fi
          
          BRANCH=$(git branch --show-current)
          if [[ "$BRANCH" != "main" && "$BRANCH" != "master" ]]; then
            git push origin "$BRANCH" || true
          fi

      # Remove :eyes:, add :+1:
      - name: Update reaction
        if: always() && steps.context.outputs.comment_id != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Remove eyes
          REACTION_ID=$(gh api "/repos/${{ github.repository }}/issues/comments/${{ steps.context.outputs.comment_id }}/reactions" \
            --jq '.[] | select(.content == "eyes" and .user.login == "sisyphus-dev-ai") | .id' | head -1)
          if [[ -n "$REACTION_ID" ]]; then
            gh api -X DELETE "/repos/${{ github.repository }}/reactions/${REACTION_ID}" || true
          fi
          
          # Add thumbs up
          gh api "/repos/${{ github.repository }}/issues/comments/${{ steps.context.outputs.comment_id }}/reactions" \
            -X POST -f content="+1" || true
